<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PO-AI Chat (Study Mode)</title>
<link rel="stylesheet" href="">
<style>
:root{--bg:#071026;--card:#0f1724;--accent:#6ee7b7;--muted:#94a3b8;--user:#0ea5e9}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,#031026,#071026);color:#e6eef8;display:flex;justify-content:center;align-items:center;height:100vh}
.app{width:100%;max-width:980px;height:92vh;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
.header{padding:12px 16px;background:linear-gradient(90deg,#07192a,#08172a);display:flex;align-items:center;gap:12px}
.title{font-size:18px;font-weight:700}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.modeBtn{background:#0b2440;color:#bfeee0;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
.main{flex:1;display:flex;gap:12px}
.chat{flex:1;background:var(--card);display:flex;flex-direction:column;overflow:hidden;padding:12px}
.messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:10px}
.msg{max-width:75%;padding:12px;border-radius:12px;font-size:15px;line-height:1.3}
.user{align-self:flex-end;background:linear-gradient(180deg,var(--user),#0284c7);color:#001}
.bot{align-self:flex-start;background:linear-gradient(180deg,#1b2a38,#16202a);color:#e6eef8}
.inputBar{display:flex;padding:12px;background:linear-gradient(180deg,#051223,#061226);gap:8px}
.inputBar input{flex:1;padding:12px;border-radius:10px;border:1px solid #0b2236;background:#081426;color:#e6eef8}
.btn{padding:10px 12px;border-radius:10px;border:none;background:#0ea5e9;color:#012;cursor:pointer}
.mic{background:#16a34a;color:white}
.teach{background:#7c3aed;color:white}
.side{width:320px;background:linear-gradient(180deg,#071322,#081427);padding:12px;display:flex;flex-direction:column}
.side h4{margin:6px 0;color:#9fbfcf}
.item{padding:8px;border-radius:8px;background:#071a2a;border:1px solid #123048;margin-bottom:8px}
.small{font-size:13px;color:#94a3b8}
@media(max-width:900px){.side{display:none}.app{height:100vh}}
</style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">ðŸ¤– PO-AI Chat (with Study Mode)</div>
      <div class="controls">
        <button id="modeBtn" class="modeBtn">Mode: PO</button>
      </div>
    </div>

    <div class="main">
      <div class="chat">
        <div id="messages" class="messages"></div>

        <div class="inputBar">
          <input id="inputText" placeholder="Type or press mic to speak..." />
          <button id="sendBtn" class="btn">Send</button>
          <button id="micBtn" class="btn mic">ðŸŽ¤</button>
          <button id="teachBtn" class="btn teach">Teach</button>
        </div>
      </div>

      <aside class="side">
        <h4>Study Memory (latest)</h4>
        <div id="studyList"></div>
        <div style="margin-top:auto" class="small">Tips: In PO mode ask like "vinayak rampur eucalyptus". In Study mode press Teach to save content. OpenAI used for fallback human-like answers.</div>
      </aside>
    </div>
  </div>

<script>
/* client logic */
let mode = "po"; // "po", "study", "normal"
const messages = document.getElementById("messages");
const inputText = document.getElementById("inputText");
const sendBtn = document.getElementById("sendBtn");
const micBtn = document.getElementById("micBtn");
const teachBtn = document.getElementById("teachBtn");
const modeBtn = document.getElementById("modeBtn");
const studyList = document.getElementById("studyList");

function addMsg(txt, who="bot") {
  const d = document.createElement("div");
  d.className = "msg " + (who==="user"?"user":"bot");
  d.innerHTML = txt;
  messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
}

function speakLast4(po) {
  const last4 = (po+"").slice(-4);
  const map = {"0":"zero","1":"one","2":"two","3":"three","4":"four","5":"five","6":"six","7":"seven","8":"eight","9":"nine"};
  const words = last4.split("").map(d=>map[d]||d).join(" ");
  const u = new SpeechSynthesisUtterance(words);
  u.lang = "en-IN";
  speechSynthesis.speak(u);
}

async function refreshStudyList(){
  try{
    const r = await fetch("/study/list");
    const j = await r.json();
    studyList.innerHTML = "";
    j.slice(0,8).forEach(it=>{
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `<strong>${escapeHtml(it.title)}</strong><div class="small">${escapeHtml(it.content).slice(0,140)}</div>`;
      studyList.appendChild(el);
    });
  }catch(e){}
}
function escapeHtml(s){return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}

/* send message */
async function sendMessage(msg){
  if(!msg) return;
  addMsg(escapeHtml(msg), "user");
  inputText.value = "";
  try{
    const res = await fetch("/chat", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ message: msg, mode: mode })
    });
    const j = await res.json();
    if(j.type === "po"){
      const list = j.results || [];
      if(list.length === 0){ addMsg("No PO found.", "bot"); return; }
      // show only PO lines
      const html = list.map(it => `PO: <b>${escapeHtml(it.PO)}</b>`).join("<br>");
      addMsg(html, "bot");
      // copy first PO
      try{ await navigator.clipboard.writeText(list[0].PO); }catch(e){}
      // speak only last 4 digits as words
      speakLast4(list[0].PO);
    } else if(j.type === "study" && j.source === "stored"){
      addMsg(escapeHtml(j.answer), "bot");
      const u = new SpeechSynthesisUtterance(j.answer); u.lang="en-IN"; speechSynthesis.speak(u);
    } else if(j.type === "ai"){
      addMsg(escapeHtml(j.answer), "bot");
      const u = new SpeechSynthesisUtterance(j.answer); u.lang="en-IN"; speechSynthesis.speak(u);
    } else {
      addMsg(JSON.stringify(j), "bot");
    }
  }catch(err){
    addMsg("Server error.", "bot");
  } finally {
    refreshStudyList();
  }
}

/* event handlers */
sendBtn.addEventListener("click", ()=>{ const t=inputText.value.trim(); if(t) sendMessage(t); });
inputText.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendBtn.click(); }});

modeBtn.addEventListener("click", ()=>{
  if(mode === "po"){ mode = "study"; modeBtn.textContent = "Mode: STUDY"; addMsg("Study mode enabled. Messages you Teach will be stored.", "bot"); }
  else if(mode === "study"){ mode = "normal"; modeBtn.textContent = "Mode: NORMAL"; addMsg("Normal mode enabled. Bot will use study memory + AI fallback.", "bot"); }
  else { mode = "po"; modeBtn.textContent = "Mode: PO"; addMsg("PO mode enabled. I will search PO CSV first.", "bot"); }
});

teachBtn.addEventListener("click", async ()=>{
  const t = inputText.value.trim();
  if(!t){ alert("Type the content you want to teach then press Teach."); return; }
  try{
    const payload = { title: t.slice(0,80), content: t };
    const r = await fetch("/study/add", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const j = await r.json();
    if(j.ok){ addMsg("Saved to study memory âœ…", "bot"); inputText.value=""; refreshStudyList(); }
    else addMsg("Save failed: "+(j.error||"unknown"), "bot");
  }catch(e){ addMsg("Save error", "bot"); }
});

/* mic */
let recognition;
if("webkitSpeechRecognition" in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-IN"; recognition.interimResults=false; recognition.maxAlternatives=1;
  recognition.onresult = e => { const t = e.results[0][0].transcript; inputText.value=t; sendMessage(t); };
  recognition.onerror = e => { addMsg("Mic error: "+(e.error||"unknown"), "bot"); };
} else { micBtn.disabled = true; micBtn.textContent="No Mic"; }
micBtn.addEventListener("click", ()=> recognition && recognition.start());

/* bootstrap */
addMsg("Namaste! Mode: PO. Ask PO queries or switch mode to Study to teach the bot.", "bot");
refreshStudyList();
</script>
</body>
</html>
